\section{Progettazione logica}
\subsection{Stima del volume dei dati}
Si suppone che siano state giocate 10 partite alla quale hanno partecipato ogni volta 4 giocatori diversi. Le partite sono state giocate solo con l'espansione base (8 seguaci per giocatore e 62 tessere totali).
\medskip

\centerline{\begin{tabular}{ |l|c|c| }
\hline
\textbf{Concetto} & \textbf{Tipo} & \textbf{Volume} \\
\hline
Player & E & 40 \\
Participation & R & 40 \\
PlayerInGame & E & 40 \\
Having & R & 40 \\
Color & E & 10 \\
\hline
Meeple & E & 320 \\
Owning & R & 320 \\
Classification & R & 320 \\
BasicMeeple & E & 1 \\
ExpansionMeeple & E & 1 \\
Using & R & 1 \\
\hline
GameSet & E & 1.500 \\
Classification & R & 1.500 \\
BasicGameSet & E & 1 \\
ExpansionGameSet & E & 0 \\
Using & R & 0 \\
\hline
Game & E & 10 \\
Participation & R & 40 \\
Composition & R & 620 \\
Hosting & R & 10 \\
Using & R & 10 \\
\hline
Expansion & E & 4 \\
\hline
Server & E & 10 \\
Location & R & 10 \\
Region & E & 6 \\
Composition & R & 6 \\
Continent & E & 4 \\
Composition & R & 6 \\
CardinalPoint & E & 5 \\
\hline
\end{tabular}
\begin{tabular}{ |l|c|c| }
\hline
\textbf{Concetto} & \textbf{Tipo} & \textbf{Volume} \\
\hline
Tile & E & 620 \\
Classification & R & 620 \\
BasicTile & E & 18 \\
ExpansionTile & E & 7 \\
Using & R & 7 \\
Composition & R & 8.060 \\
\hline
TileSection & E & 8.060 \\
Composition & R & 8.060 \\
Classification & R & 8.060 \\
Placement & R & 200 \\
TileSectionType & E & 13 \\
Preceding & R & 12 \\
Composition & R & 234 \\
\hline
TileTypeConfiguration & E & 234 \\
Composition & R & 234 \\
Description & R & 234 \\
\hline
\end{tabular}}
\subsection{Descrizione delle operazioni principali e stima della frequenza}
Si suppone che ogni giorno vengano giocate 10 partite alla quale partecipano ogni volta 4 giocatori diversi. Le partite vengono sempre concluse nell'arco della giornata e si prevede che mediamente vengono giocate 70 tessere a partite.
\medskip

\centerline{\begin{tabular}{ |c|l|c| }
\hline
\textbf{Cod.} & \textbf{Operazione} & \textbf{Frequenza} \\
\hline
1 & Creare una nuova partita & 10 al giorno \\
\hline
2 & Visualizzare i server di gioco disponibili & 10 al giorno \\
\hline
3 & Visualizzare tutte le espansioni & 10 al giorno \\
\hline
4 & Creare un nuovo giocatore & 40 al giorno \\
\hline
5 & Visualizzare tutti i colori & 40 al giorno \\
\hline
6 & Ruotare la tessera corrente & 300 al giorno \\
\hline
7 & Piazzare la tessera corrente & 700 al giorno \\
\hline
8 & Piazzare o rimuovere un seguace su una sezione di una tessera & 350 al giorno \\
\hline
9 & Visualizzare i seguaci disponibili & 700 al giorno \\
\hline
10 & Assegnare dei punti ad un giocatore & 200 al giorno \\
\hline
11 & Aggiornare la tessera corrente & 700 al giorno \\
\hline
12 & Aggiornare il giocatore corrente & 700 al giorno \\
\hline
13 & Visualizzare le partire non concluse & 5 al giorno \\
\hline
14 & Visualizzare i giocatori di una partita & 70 al giorno \\
\hline
15 & Visualizzare le tessere piazzate & 5 al giorno \\
\hline
16 & Visualizzare le regioni in ordine di punteggio medio dei giocatori & 2 al mese \\
\hline
17 & Mostrare per ogni giocatore il numero di avversari con cui ha giocato & 4 all'anno \\
\hline
18 & Visualizzare per ogni regione l'espansione più giocata & 1 al mese \\
\hline
19 & Mostrare per ogni colore la probabilità statistica di vincere & 1 al giorno \\
\hline
\end{tabular}}

\subsection{Schemi di navigazione e tabelle degli accessi}

\subsection{Raffinamento dello schema}
(eliminazione di identificatori esterni, attributi composti e gerarchie, scelta delle chiavi)
\medskip

(elimanzione dell'attributo composto Position e l'inserimento delle due coordinate)

\subsection{Analisi delle ridondanze}

\subsection{Traduzione di entità e associazioni in relazioni}
\hspace{1.5em}players(\textbf{name})\newline

colors(\textbf{hex}, red, green, blue, name)\newline

games(\textbf{id}, server\_id, concluded)\newline
FK: server\_id REFERENCES servers(id)\newline

players\_in\_game(\textbf{player\_name}, \textbf{game\_id}, color\_hex, score, current, order)\newline
FK: player\_name REFERENCES players(name)\newline
FK: game\_id REFERENCES games(id)\newline
FK: color\_hex REFERENCES colors(hex)\newline

games\_expansions(\textbf{expansion\_name}, \textbf{game\_id})\newline
FK: game\_id REFERENCES games(id)\newline
FK: expansion\_name REFERENCES expansions(name)\newline

expansions(\textbf{name})\newline

meeple\_types(\textbf{name}, quantity, strength, expansion\_name)\newline
FK: expansion\_name REFERENCES expansions(name)\newline

meeples(\textbf{id}, owner\_player\_name, owner\_game\_id, type\_name, placed)\newline
FK: owner\_player\_name REFERENCES players\_in\_game(player\_name)\newline
FK: owner\_game\_id REFERENCES players\_in\_game(game\_id)\newline
FK: type\_name REFERENCES meeple\_types(name)\newline

gamesets(\textbf{id}, type\_name, points, closed)\newline
FK: type\_name REFERENCES gameset\_types(name)\newline

gameset\_types(\textbf{name}, starting\_points, endgame\_ratio, expansion\_name)\newline
FK: expansion\_name REFERENCES expansions(name)\newline

tile\_section\_types(\textbf{name}, next\_name*, previous\_name*)\newline
FK: next\_name REFERENCES tile\_section\_types(name)\newline
FK: previous\_name REFERENCES tile\_section\_types(name)\newline

tile\_sections(\textbf{type\_name}, \textbf{tile\_order}, \textbf{tile\_game\_id}, gameset\_id, meeple\_id*, closed)\newline
FK: type\_name REFERENCES tile\_section\_types(name)\newline
FK: tile\_order REFERENCES tiles(order)\newline
FK: tile\_game\_id REFERENCES tiles(game\_id)\newline
FK: meeple\_id REFERENCES meeples(id)\newline
FK: gameset\_id REFERENCES gamesets(id)\newline

tiles(\textbf{order}, \textbf{game\_id}, type\_name, rotation\_count, x\_coordinate*, y\_coordinate*, current)\newline
FK: type\_name REFERENCES tile\_types(name)\newline
FK: game\_id REFERENCES games(id)\newline

tile\_types(\textbf{name}, quantity, expansion\_name)\newline
FK: expansion\_name REFERENCES expansions(name)\newline

tile\_type\_configurations(id, \textbf{tile\_section\_type\_name}, \textbf{tile\_type\_name}, gameset\_type\_name, closed, pennant)\newline
FK: tile\_section\_type\_name REFERENCES tile\_section\_types(name)\newline
FK: tile\_type\_name REFERENCES tile\_types(name)\newline
FK: gameset\_type\_name REFERENCES gameset\_types(name)\newline

regions(\textbf{id}, continent\_name, cardinal\_point\_name*)\newline
FK: continent\_name REFERENCES continents(name)\newline
FK: cardinal\_point\_name REFERENCES cardinal\_points(name)\newline

continents(\textbf{name})\newline

cardinal\_points(\textbf{name})\newline

servers(\textbf{id}, region\_id, active, max\_games)\newline
FK: region\_id REFERENCES regions(id)

\subsection{Schema relazionale finale}
\begin{figure}[hb]
    \centering\includegraphics[scale=0.06]{images/Progettazione/relazionale.png}
    \caption{Schema concettuale finale.}
\end{figure}

\subsection{Traduzione delle operazioni in query SQL}
\subsubsection*{OP1 - Creare una nuova partita}

\subsubsection*{OP2 - Visualizzare i server di gioco disponibili}
\begin{lstlisting}[style=sql]
    SELECT * FROM servers AS s WHERE active=true AND max_games > (SELECT COUNT(*) FROM games AS g WHERE g.server_ID=s.ID)
\end{lstlisting}

\subsubsection*{OP3 - Visualizzare tutte le espansioni}

\subsubsection*{OP4 - Creare un nuovo giocatore}

\subsubsection*{OP5 - Visualizzare tutti i colori}

\subsubsection*{OP6 - Ruotare la tessera corrente}

\subsubsection*{OP7 - Piazzare la tessera corrente}

\subsubsection*{OP8 - Piazzare o rimuovere un seguace su una sezione di una tessera}

\subsubsection*{OP9 - Visualizzare i seguaci disponibili}

\subsubsection*{OP10 - Assegnare dei punti ad un giocatore}

\subsubsection*{OP11 - Aggiornare la tessera corrente}

\subsubsection*{OP12 - Aggiornare il giocatore corrente}

\subsubsection*{OP13 - Visualizzare le partire non concluse}

\subsubsection*{OP14 - Visualizzare i giocatori di una partita}

\subsubsection*{OP15 - Visualizzare le tessere piazzate}

\subsubsection*{OP16 - Visualizzare le regioni in ordine di punteggio medio dei giocatori}
\begin{lstlisting}[style=sql]
    SELECT R.id, AVG(P.score) AS AveragePlayerScore FROM ((regions R INNER JOIN servers S on R.id = S.region_id) INNER JOIN games G ON S.id = G.server_id) INNER JOIN players_in_game P ON G.id = P.game_id
    WHERE G.concluded = TRUE GROUP BY R.id ORDER BY AveragePlayerScore DESC;
\end{lstlisting}

\subsubsection*{OP17 - Mostrare per ogni giocatore il numero di avversari con cui ha giocato}
\begin{lstlisting}[style=sql]
    SELECT P.player_name, (SELECT COUNT(DISTINCT P2.player_name) AS EnemiesCount FROM players_in_game P2 INNER JOIN games G2 on P2.game_id = G2.id
    WHERE G2.id IN (SELECT DISTINCT P3.game_id FROM players_in_game P3 WHERE P3.player_name = P.player_name) AND P2.player_name <> P.player_name) AS EnemiesCount
    FROM players_in_game P INNER JOIN games G on P.game_id = G.id
    GROUP BY P.player_name ORDER BY EnemiesCount DESC;
\end{lstlisting}

\subsubsection*{OP18 - Visualizzare per ogni regione l'espansione più giocata}
\begin{lstlisting}[style=sql]
    SELECT SQ.id, SQ.expansion_name, MAX(SQ.GamesCount) AS MaxGamesCount FROM (
        SELECT R.id, GE.expansion_name, COUNT(GE.expansion_name) AS GamesCount FROM ((regions R INNER JOIN servers S on R.id = S.region_id) INNER JOIN games G ON G.server_id = S.id) INNER JOIN games_expansions GE ON GE.game_id = G.id
        WHERE GE.expansion_name <> 'Basic' GROUP BY R.id, GE.expansion_name) AS SQ
    GROUP BY SQ.id ORDER BY SQ.id ASC;
\end{lstlisting}

\subsubsection*{OP19 - Mostrare per ogni colore la probabilità statistica di vincere}
\begin{lstlisting}[style=sql]
    SELECT c.name, (SUM(CASE WHEN pig.Score = max_scores.max_score THEN 1 ELSE 0 END) / COUNT(*)) AS WinProbability
FROM colors c
JOIN players_in_game pig ON c.hex = pig.color_hex
JOIN (
    SELECT game_id, MAX(Score) AS max_score
    FROM players_in_game
    GROUP BY game_id
) max_scores ON pig.game_id = max_scores.game_id
JOIN games g ON pig.game_id = g.id
WHERE g.concluded = true
GROUP BY c.hex, c.name;
\end{lstlisting}
